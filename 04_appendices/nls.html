
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>17.1. Nonlinear Least Squares &#8212; All Models Are Uncertain</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8f53015daec13862f6db5e763c41738.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="17. Inverse Propagation" href="inv-propagation.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      <h1 class="site-logo" id="site-title">All Models Are Uncertain</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00_frontmatter/landing-page.html">
   All Models Are Uncertain
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Orienting
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../01_orienting/orienting.html">
   1. Orienting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01_orienting/modeling-questions.html">
   2. Types of Modeling Questions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01_orienting/curiosity-skepticism.html">
   3. Curiosity and Skepticism: A Healthy Mindset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01_orienting/grama-intro.html">
   4. A Grammar of Model Analysis: Grama
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Diagnosing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_diagnosing/diagnosing.html">
   5. Diagnosing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_diagnosing/uncertainty.html">
     5.2. Conceptual Tools for Handling Uncertainty
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_diagnosing/distributions.html">
   6. Distributions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_diagnosing/marginals.html">
     6.2. Single-uncertainties: Marginal Distributions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_diagnosing/dependency.html">
     6.3. Multiple-uncertainties: Copulas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_diagnosing/estimation.html">
     6.4. Dealing with Limited Data: Estimation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02_diagnosing/functions.html">
   7. Functions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02_diagnosing/model-form-error.html">
     7.1. Model-Form Error and Validation
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Advancing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../03_advancing/advancing.html">
   8. Advancing
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Bibliography
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../zbib.html">
   9. Bibliography
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="cases.html">
   10. Cases
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="alloys.html">
     10.10. Alloy Datasets
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="grama.html">
   11. Grama Reference Materials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="eda.html">
   12. Basics of Exploratory Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="pr-modeling.html">
   13. Probability and Modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dim-reduction.html">
   14. Dimension Reduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="empirical-models.html">
   15. Empirical Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fwd-propagation.html">
   16. Forward Propagation
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="inv-propagation.html">
   17. Inverse Propagation
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     17.1. Nonlinear Least Squares
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/04_appendices/nls.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/04_appendices/nls.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#definitions-a-id-definitions-a">
   17.1.1. Definitions
   <a id="definitions">
   </a>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-need-for-general-purpose-optimization-a-id-challenge-opt-a">
   17.1.2. The Need for General-purpose Optimization
   <a id="challenge-opt">
   </a>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#procedure">
     17.1.2.1. Procedure
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#routine-fit-nls">
     17.1.2.2. Routine:
     <code class="docutils literal notranslate">
      <span class="pre">
       fit_nls()
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quick-demonstration">
   17.1.3. Quick Demonstration
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#uq-capabilities-linearized-and-pooled-parameter-estimation">
     17.1.3.1. UQ Capabilities: Linearized and Pooled parameter estimation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#challenges">
   17.1.4. Challenges
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#challenge-premature-termination-a-id-challenge-termination-a">
     17.1.4.1. Challenge: Premature Termination
     <a id="challenge-termination">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resolution-tighten-the-tolerances">
     17.1.4.2. Resolution: Tighten the tolerances
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#challenge-unidentifiable-models-a-id-challenge-unidentifiable-a">
     17.1.4.3. Challenge: Unidentifiable Models
     <a id="challenge-unidentifiable">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#resolution-reformulation">
     17.1.4.4. Resolution: Reformulation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#challenge-local-minima-a-id-challenge-minima-a">
     17.1.4.5. Challenge: Local Minima
     <a id="challenge-minima">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#partial-resolution-restarts">
     17.1.4.6. Partial Resolution: Restarts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#partial-resolution-restrict-parameter-domain">
     17.1.4.7. Partial Resolution: Restrict parameter domain
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-takeaways">
   17.1.5. Key Takeaways
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#grama-routines-a-id-grama-a">
   17.1.6. Grama Routines
   <a id="grama">
   </a>
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="nonlinear-least-squares">
<span id="nls"></span><h1><span class="section-number">17.1. </span>Nonlinear Least Squares<a class="headerlink" href="#nonlinear-least-squares" title="Permalink to this headline">¶</a></h1>
<p><strong>Learning Objectives</strong>: In this notebook, you will learn</p>
<ul class="simple">
<li><p>the mathematical formulation of <em>nonlinear least squares</em> (NLS)</p></li>
<li><p>the need for general-purpose optimization with NLS</p></li>
<li><p>how to use the <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> routine to perform NLS</p></li>
<li><p>how to recognize and resolve premature optimization termination</p></li>
<li><p>how to recognize and resolve issues of model unidentifiability</p></li>
<li><p>how to recognize and resolve issues of local minima</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grama</span> <span class="k">as</span> <span class="nn">gr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">grama.models</span> <span class="kn">import</span> <span class="n">make_trajectory_linear</span>
<span class="kn">from</span> <span class="nn">grama.data</span> <span class="kn">import</span> <span class="n">df_trajectory_windowed</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Intention</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="definitions-a-id-definitions-a">
<h2><span class="section-number">17.1.1. </span>Definitions <a id="definitions"></a><a class="headerlink" href="#definitions-a-id-definitions-a" title="Permalink to this headline">¶</a></h2>
<p><strong>Definition</strong>: The <em>mean squared error</em> (MSE) is defined by</p>
<div class="math notranslate nohighlight">
\[\text{MSE}(\theta) = \sum_{i=1}^{N_{\text{data}}} (\hat{f}_i(\theta) - f_i)^2.\]</div>
<p><strong>Definition</strong>: <em>Nonlinear least squares</em> (NLS) optimization is the fitting of a model <span class="math notranslate nohighlight">\(\hat{f}(\theta)\)</span> via minimization of the MSE</p>
<div class="math notranslate nohighlight">
\[\theta^* = \text{argmin}_{\theta} \text{MSE}(\theta),\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{f}(\theta)\)</span> is nonlinear in <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>In contrast with ordinary least squares, the model <span class="math notranslate nohighlight">\(\hat{f}(\theta)\)</span> does not have any special structure. This introduces a few new challenges.</p>
</div>
<div class="section" id="the-need-for-general-purpose-optimization-a-id-challenge-opt-a">
<h2><span class="section-number">17.1.2. </span>The Need for General-purpose Optimization <a id="challenge-opt"></a><a class="headerlink" href="#the-need-for-general-purpose-optimization-a-id-challenge-opt-a" title="Permalink to this headline">¶</a></h2>
<p>In contrast with ordinary least squares—which has special structure that admits an analytic solution to minimize the MSE—the NLS minimization problem does not have a general analytic solution. This means one must use some form of general-purpose optimization to minimize the MSE. A generic procedure is as follows:</p>
<div class="section" id="procedure">
<h3><span class="section-number">17.1.2.1. </span>Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Select initial guess <span class="math notranslate nohighlight">\(\theta_j\)</span> for <span class="math notranslate nohighlight">\(j=0\)</span></p></li>
<li><p>Compute fit <span class="math notranslate nohighlight">\(\hat{f}_i(\theta_j)\)</span> for each data point</p></li>
<li><p>Compute mean squared error <span class="math notranslate nohighlight">\(\text{MSE}(\theta_j)\)</span></p></li>
<li><p>Select next <span class="math notranslate nohighlight">\(\theta_{j+1}\)</span> by seeking a minimum of MSE</p></li>
<li><p>Repeat from (2) until MSE is sufficiently converged</p></li>
</ol>
<p>The selection of an initial guess <span class="math notranslate nohighlight">\(\theta_0\)</span> and the procedure for selecting new iterations <span class="math notranslate nohighlight">\(\theta_{j+1}\)</span> are important considerations, but are also highly problem-dependent.</p>
<p>The <a class="reference external" href="#grama">Grama</a> section below lists implementations of NLS, including the routine <code class="docutils literal notranslate"><span class="pre">gr.fit_nls()</span></code>. This general-purpose routine provides sensible defaults for <span class="math notranslate nohighlight">\(\theta_0\)</span> and an iteration strategy, but is customizable.</p>
</div>
<div class="section" id="routine-fit-nls">
<h3><span class="section-number">17.1.2.2. </span>Routine: <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code><a class="headerlink" href="#routine-fit-nls" title="Permalink to this headline">¶</a></h3>
<p>The workhorse Grama routine for solving nonlinear least squares problems is <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>. As the prefix implies this is a routine that takes a dataset and returns a Grama model. The primary benefit of <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> (over other empirical fitting routines) is that it takes a Grama model as an <em>input</em>: This allows the user to fully specify the model structure. The routine <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> compares the provided dataset and model, automatically determines which parameters to fit, and performs iterative minimization of the MSE to find best-fit parameter values.</p>
<p>Under the hood <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> calls the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">scipy.minimize</a> routine with the bounds provided by the model to fit. Since only a subset of scipy’s optimization routines are compatible with bounds, <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> can only use those optimizers. As of writing (2020-11-16) those routines are <code class="docutils literal notranslate"><span class="pre">L-BFGS-B,</span> <span class="pre">TNC,</span> <span class="pre">SLSQP,</span> <span class="pre">Powell,</span></code> and <code class="docutils literal notranslate"><span class="pre">trust-constr</span></code>.</p>
<p>You can read the documentation for <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> for more information! Don’t forget that you can also reference this while coding to remind yourself of the routine’s arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># help(gr.fit_nls) # Uncomment to read the documentation</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="quick-demonstration">
<h2><span class="section-number">17.1.3. </span>Quick Demonstration<a class="headerlink" href="#quick-demonstration" title="Permalink to this headline">¶</a></h2>
<p>To start, let’s take a look at a quick demonstration of using <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Load pre-made trajectory model</span>
<span class="n">md_trajectory</span> <span class="o">=</span> <span class="n">make_trajectory_linear</span><span class="p">()</span>
<span class="c1">## Fit trajectory model with NLS</span>
<span class="n">md_trajectory_fitted</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">fit_nls</span><span class="p">(</span>
    <span class="n">df_trajectory_windowed</span><span class="p">,</span>
    <span class="n">md</span><span class="o">=</span><span class="n">md_trajectory</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: Unknown solver options: gtol
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        v0         u0      tau  v0_0  u0_0  tau_0  success  \
0  28.2348  18.792167  2.80225   0.1   0.1   0.05     True   

                                message  n_iter       mse  
0  Optimization terminated successfully      46  0.093358  
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: Unknown solver options: gtol
</pre></div>
</div>
</div>
</div>
<p>Let’s parse the printout from <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> is implemented using <code class="docutils literal notranslate"><span class="pre">eval_nls()</span></code> to carry out the optimization, the printout <code class="docutils literal notranslate"><span class="pre">setting</span></code> lines report that the routine has inspected the provided data and Grama model and determined a set of outputs <code class="docutils literal notranslate"><span class="pre">out</span></code> for which data is available, a set of variables <code class="docutils literal notranslate"><span class="pre">var_fix</span></code> to fix to constant values, and a set of variables <code class="docutils literal notranslate"><span class="pre">var_feat</span></code> to treat as features in the model that index different observations on the outputs.</p>
<p><code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> also echoes the best-fit parameter values along with optimizer details; the routine denotes initial guess values with the <code class="docutils literal notranslate"><span class="pre">_0</span></code> suffix along with the best-fit parameter values. Optimization details include the <code class="docutils literal notranslate"><span class="pre">success,</span> <span class="pre">message</span></code> codes and the <code class="docutils literal notranslate"><span class="pre">MSE</span></code> value associated with each restart. If multiple restarts are used, then a single row is reported for each restart.</p>
<p>While these numeric details are very useful for debugging, it is important to conduct a visual inspection of fitted model results as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Evaluate and plot fitted trajectory</span>
<span class="n">df_trajectory_fitted</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_df</span><span class="p">(</span><span class="n">md_trajectory_fitted</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df_trajectory_windowed</span><span class="p">)</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_trajectory_fitted</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_trajectory_windowed</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... provided columns intersect model output.
eval_df() is dropping {&#39;y&#39;, &#39;x&#39;}
</pre></div>
</div>
<img alt="../_images/nls_9_1.png" src="../_images/nls_9_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778601249785)&gt;
</pre></div>
</div>
</div>
</div>
<p>A quick visual inspection of the model results indicates a good fit, but this is different from the model being <em>validated</em>. See the <a class="reference internal" href="../02_diagnosing/model-form-error.html#model-form-error"><span class="std std-ref">chapter on model-form error</span></a> for more information.</p>
<div class="section" id="uq-capabilities-linearized-and-pooled-parameter-estimation">
<h3><span class="section-number">17.1.3.1. </span>UQ Capabilities: Linearized and Pooled parameter estimation<a class="headerlink" href="#uq-capabilities-linearized-and-pooled-parameter-estimation" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> routine implements an approximate method for parameter uncertainty quantification based on a <em>linearized</em> model. This option is enabled by setting <code class="docutils literal notranslate"><span class="pre">uq_method=&quot;linpool&quot;</span></code>. While fitting is carried out using the full nonlinear model, a post-processing step is carried out at the optimized parameter value <span class="math notranslate nohighlight">\(\theta^*\)</span>.</p>
<p>This statistical procedure assumes the following model</p>
<div class="math notranslate nohighlight">
\[f_{i, j} = \hat{f}_{i, j} + \epsilon_{i, j},\]</div>
<p>where <span class="math notranslate nohighlight">\(i\)</span> indexes observations, <span class="math notranslate nohighlight">\(j\)</span> indexes model outputs, and <span class="math notranslate nohighlight">\(\epsilon_{i,j} \sim N(0, \sigma_j^2)\)</span> are iid. Under these assumptions the parameter are asymptotically normally distributed, with correlations related to the gradient of the function <span id="id1">[]</span>. Since the parameters are shared among all function outputs, the <code class="docutils literal notranslate"><span class="pre">linpool</span></code> method simply averages (pools) the variance matrices from each output.</p>
<p>The following example demonstrates this UQ procedure on the trajectory example: fitting the nonlinear model, estimating a distribution for the parameters, and drawing an ensemble of trajectories to illustrate the parameteric uncertainty in the resulting fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Fit trajectory model with linpool enabled</span>
<span class="n">md_trajectory_uq</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">fit_nls</span><span class="p">(</span>
    <span class="n">df_trajectory_windowed</span><span class="p">,</span>
    <span class="n">md</span><span class="o">=</span><span class="n">md_trajectory</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
    <span class="n">uq_method</span><span class="o">=</span><span class="s2">&quot;linpool&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">## Visualize ensemble of trajectories</span>
<span class="n">df_trajectory_uq</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_monte_carlo</span><span class="p">(</span><span class="n">md_trajectory_uq</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">df_det</span><span class="o">=</span><span class="n">df_trajectory_windowed</span><span class="p">)</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df_trajectory_uq</span><span class="p">,</span> 
        <span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;tau&quot;</span><span class="p">),</span> 
        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_trajectory_windowed</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
        v0         u0      tau  v0_0  u0_0  tau_0  success  \
0  28.2348  18.792167  2.80225   0.1   0.1   0.05     True   

                                message  n_iter       mse  
0  Optimization terminated successfully      46  0.093358  
... provided columns intersect model output.
eval_df() is dropping {&#39;y&#39;, &#39;x&#39;}
... provided columns intersect model output.
eval_df() is dropping {&#39;y&#39;, &#39;x&#39;}
</pre></div>
</div>
<img alt="../_images/nls_12_1.png" src="../_images/nls_12_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778601135745)&gt;
</pre></div>
</div>
</div>
</div>
<p>Combining UQ methods with NLS provides more information; above we can see that the uncertainty in the trajectory is small near the beginning but begins to spread as deviations accumulate over time. When making predictions with NLS we can use UQ techniques to construct error bars. This can help us accurately assess the confidence in our predictions, enabling better decision making.</p>
</div>
</div>
<div class="section" id="challenges">
<h2><span class="section-number">17.1.4. </span>Challenges<a class="headerlink" href="#challenges" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p>Since NLS is a general technique that one can apply to fit an arbitrary model, it is important to be alert for many <em>challenges</em> that may arise in fitting a model. The following sections details common challenges in applying NLS and some strategies to overcome those challenges.</p>
<div class="section" id="challenge-premature-termination-a-id-challenge-termination-a">
<h3><span class="section-number">17.1.4.1. </span>Challenge: Premature Termination <a id="challenge-termination"></a><a class="headerlink" href="#challenge-premature-termination-a-id-challenge-termination-a" title="Permalink to this headline">¶</a></h3>
<p>Generally we want the <em>best</em> fit of a model, as represented by the <em>globally minimum</em> MSE. However, practical optimization algorithms are only capable of converging to within a finite <em>tolerance</em> of the true optimum. If optimization stops before it is sufficiently converged, then the model fit may not be sufficiently accurate for our purposes.</p>
<p>To illustrate the challenges of premature optimization termination, let’s set up an example where the MSE will tend to be dramatically large. To that end, the following code sets up an exponential model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Define exponential model</span>
<span class="n">md_decay</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;Decay Model&quot;</span><span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_function</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">],</span>
        <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_bounds</span><span class="p">(</span>
        <span class="n">a</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="c1">## Generate data under a = 2</span>
<span class="n">df_decay_data</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_df</span><span class="p">(</span><span class="n">md_decay</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">df_make</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">)))</span>
<span class="c1">## Plot</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df_decay_data</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nls_16_0.png" src="../_images/nls_16_0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778599043213)&gt;
</pre></div>
</div>
</div>
</div>
<p>To demonstrate what happens when optimization stops prematurely, let’s set the optimization tolerances to be deliberately loose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_decay_fit</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">fit_nls</span><span class="p">(</span>
    <span class="n">df_decay_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]],</span>
    <span class="n">md</span><span class="o">=</span><span class="n">md_decay</span><span class="p">,</span>
    <span class="c1"># Deliberately set a loose convergence tolerance</span>
    <span class="n">ftol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">gtol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;]
... eval_nls setting out = [&#39;y&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
     a  a_0  success                                          message  n_iter  \
0  1.0  5.5     True  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       1   

            mse  
0  2.606039e+07  
</pre></div>
</div>
</div>
</div>
<p>Note that the fitting results indicate that optimization terminated “successfully” (<code class="docutils literal notranslate"><span class="pre">success</span> <span class="pre">==</span> <span class="pre">True</span></code>), but clearly the fitted value for <code class="docutils literal notranslate"><span class="pre">a</span></code> does not match what we set above (<code class="docutils literal notranslate"><span class="pre">a=2</span></code>). A visual inspection of results gives a clearer picture of the misfit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_decay_fit1</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_df</span><span class="p">(</span><span class="n">md_decay_fit</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df_decay_data</span><span class="p">)</span>

<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_decay_fit1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_decay_data</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... provided columns intersect model output.
eval_df() is dropping {&#39;a&#39;, &#39;y&#39;}
</pre></div>
</div>
<img alt="../_images/nls_20_1.png" src="../_images/nls_20_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778599968461)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="resolution-tighten-the-tolerances">
<h3><span class="section-number">17.1.4.2. </span>Resolution: Tighten the tolerances<a class="headerlink" href="#resolution-tighten-the-tolerances" title="Permalink to this headline">¶</a></h3>
<p>A simple way to solve this issue is to tighten our convergence tolerance. The defaults for <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> are reasonable, so simply deleting the <code class="docutils literal notranslate"><span class="pre">ftol,</span> <span class="pre">gtol</span></code> arguments will solve this issue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_decay_fit2</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">fit_nls</span><span class="p">(</span>
    <span class="n">df_decay_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]],</span>
    <span class="n">md</span><span class="o">=</span><span class="n">md_decay</span><span class="p">,</span>
    <span class="c1"># The default tolerance is reasonable, but not guaranteed to work for all cases</span>
<span class="p">)</span>

<span class="n">md_decay_fit2</span><span class="o">.</span><span class="n">printpretty</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;]
... eval_nls setting out = [&#39;y&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
     a  a_0  success                                           message  \
0  2.0  5.5     True  CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL   

   n_iter           mse  
0       8  1.515612e-08  
model: Decay Model (Fitted)

  inputs:
    var_det:
      t: (unbounded)

    var_rand:

    copula:
      None

  functions:
      Fix variable levels: [&#39;t&#39;] -&gt; [&#39;a&#39;]
      Decay Model: [&#39;a&#39;, &#39;t&#39;] -&gt; [&#39;y&#39;]
</pre></div>
</div>
</div>
</div>
<p>Note that the fitted MSE is considerably smaller, and the fitted value matches the true value <code class="docutils literal notranslate"><span class="pre">a=2</span></code>.</p>
<p>Premature termination is not a common issue, but if you need an extremely accurate fit you may need to adjust the solver tolerances to satisfy your use case.</p>
</div>
<div class="section" id="challenge-unidentifiable-models-a-id-challenge-unidentifiable-a">
<h3><span class="section-number">17.1.4.3. </span>Challenge: Unidentifiable Models <a id="challenge-unidentifiable"></a><a class="headerlink" href="#challenge-unidentifiable-models-a-id-challenge-unidentifiable-a" title="Permalink to this headline">¶</a></h3>
<p>A more challenging problem is when the model is <em>unidentifiable</em>: when a unique MSE-minimizing parameter value does not exist. This often happens when our model has too many parameters. The following example illustrates how this can happen with the linear-drag trajectory model.</p>
<p>The following formulation of the trajectory problem includes both the (linear) drag coefficient <code class="docutils literal notranslate"><span class="pre">b</span></code> and the projectile mass <code class="docutils literal notranslate"><span class="pre">m</span></code>. Both of these parameters enter the model as the time constant <code class="docutils literal notranslate"><span class="pre">tau</span> <span class="pre">=</span> <span class="pre">-b/m</span></code>. The following code sets up this model using the analytic trajectory expressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Setup: Unidentifiable model</span>

<span class="c1">## Responses (x and y trajectory components)</span>
<span class="k">def</span> <span class="nf">fun_x</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="n">m</span>
    <span class="k">return</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">u0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="o">/</span><span class="n">tau</span><span class="p">))</span> <span class="o">+</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">fun_y</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="n">m</span>
    <span class="n">v_inf</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.8</span> <span class="o">*</span> <span class="n">tau</span>
    <span class="k">return</span> <span class="n">tau</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span> <span class="o">-</span> <span class="n">v_inf</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="o">/</span><span class="n">tau</span><span class="p">))</span> <span class="o">+</span> <span class="n">v_inf</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">0</span>

<span class="c1"># Units     (m/s) (m/s) (kg/s) (kg)  (s)</span>
<span class="n">var_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;u0&quot;</span><span class="p">,</span> <span class="s2">&quot;v0&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>   <span class="s2">&quot;m&quot;</span><span class="p">,</span>  <span class="s2">&quot;t&quot;</span><span class="p">]</span>

<span class="c1">## Assemble model</span>
<span class="n">md_trajectory_unidet</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;Trajectory Model&quot;</span><span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_function</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">fun_x</span><span class="p">,</span>
        <span class="n">var</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x_trajectory&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_function</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="n">fun_y</span><span class="p">,</span>
        <span class="n">var</span><span class="o">=</span><span class="n">var_list</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y_trajectory&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_bounds</span><span class="p">(</span>
        <span class="n">u0</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">),</span>
        <span class="n">v0</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">),</span>
        <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">m</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
        <span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s fit this model with <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>, and furthermore let’s quantify the parametric uncertainty with the <code class="docutils literal notranslate"><span class="pre">&quot;linpool&quot;</span></code> option.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_trajectory_fit</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_trajectory_windowed</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ft_nls</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md_trajectory_unidet</span><span class="p">,</span>
        <span class="n">uq_method</span><span class="o">=</span><span class="s2">&quot;linpool&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
          v0    b         u0    m  v0_0  b_0  u0_0   m_0  success  \
0  21.783001  2.0  13.147569  0.1   0.0  0.5   0.0  2.55     True   

                                            message  n_iter       mse  
0  CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL      77  3.146259  
... provided columns intersect model output.
eval_df() is dropping {&#39;y&#39;, &#39;x&#39;}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: Model is locally unidentifiable as measured by the condition number of the pooled covariance matrix; kappa = 55092486439633.15
</pre></div>
</div>
</div>
</div>
<p>The warning <code class="docutils literal notranslate"><span class="pre">Model</span> <span class="pre">is</span> <span class="pre">locally</span> <span class="pre">unidentifiable</span></code> indicates this model has identifiability issues. Furthermore the solver results indicate that fitting this model failed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&quot;linpool&quot;</span></code> UQ method estimates a covariance matrix for the parameters based on the partial derivatives <span class="math notranslate nohighlight">\(df_j/d\theta_i\)</span>. If the covariance matrix is singular, it indicates that local changes along the (joint) nullspace of the parameter gradients lead to no change in the output values—non-identical parameter values give identical model predictions. This prevents identifiability of a unique parameter value, and can lead to issues in fitting.</p>
<p>For a closer look at the nonidentifiability issues with the trajectory model above, the following code visualizes the model MSE at a grid of parameter values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Enable warnings filter; we&#39;re going to evaluate extreme values</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="c1">## Generate data under true values for u0, v0, b, m</span>
<span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">df_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">eval_df</span><span class="p">(</span>
        <span class="n">md_trajectory_unidet</span><span class="p">,</span>
        <span class="n">df</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">df_make</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">b</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_values</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1">## Sweep values of m, b; compute the MSE for each value</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">tran_outer</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">df_make</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">20</span><span class="p">)),</span>
    <span class="n">df_outer</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">df_make</span><span class="p">(</span><span class="n">m</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">+</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">20</span><span class="p">)),</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">df_row</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">df_res</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">md_trajectory_unidet</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ev_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">tran_outer</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">]],</span> <span class="n">df_outer</span><span class="o">=</span><span class="n">df_row</span><span class="p">))</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_transmute</span><span class="p">(</span><span class="n">y_pred</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_bind_cols</span><span class="p">(</span><span class="n">df_data</span><span class="p">[[</span><span class="s2">&quot;y&quot;</span><span class="p">]])</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_summarize</span><span class="p">(</span><span class="n">mse</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">mse</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_outer</span><span class="p">(</span><span class="n">df_outer</span><span class="o">=</span><span class="n">df_row</span><span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_results</span><span class="p">,</span> <span class="n">df_res</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">## Re-enable default warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Visualize the grid of values</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span>
        <span class="n">df_results</span> 
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_filter</span><span class="p">(</span>
            <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
            <span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">tf_mutate</span><span class="p">(</span><span class="n">log_mse</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">mse</span><span class="p">)),</span> 
        <span class="n">aes</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;log_mse&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_fill_cmap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_tile</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: divide by zero encountered in log
</pre></div>
</div>
<img alt="../_images/nls_30_1.png" src="../_images/nls_30_1.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778599538249)&gt;
</pre></div>
</div>
</div>
</div>
<p>Note that multiple pairs of <code class="docutils literal notranslate"><span class="pre">m,</span> <span class="pre">b</span></code> values lead to an identical MSE—this is the culprit for the unidentifiability of the model. Note that since <code class="docutils literal notranslate"><span class="pre">m,</span> <span class="pre">b</span></code> enter the model only through the ratio <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">/</span> <span class="pre">b</span></code>, any pair of <code class="docutils literal notranslate"><span class="pre">m,</span> <span class="pre">b</span></code> values with the same ratio will give produce an identical model fit.</p>
<p>To fix this unidentifiability issue, we can <em>reformulate</em> the model.</p>
</div>
<div class="section" id="resolution-reformulation">
<h3><span class="section-number">17.1.4.4. </span>Resolution: Reformulation<a class="headerlink" href="#resolution-reformulation" title="Permalink to this headline">¶</a></h3>
<p>Since the parameters <code class="docutils literal notranslate"><span class="pre">b,</span> <span class="pre">m</span></code> enter only as the combination <span class="math notranslate nohighlight">\(\tau = -b/m\)</span> we can <em>reformulate</em> the model in terms of this combined parameter. The model <code class="docutils literal notranslate"><span class="pre">md_trajectory</span></code> is implemented this way; let’s re-fit the model using this reformulated version.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_trajectory_ref</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_trajectory_windowed</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ft_nls</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md_trajectory</span><span class="p">,</span>
        <span class="n">uq_method</span><span class="o">=</span><span class="s2">&quot;linpool&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting out = [&#39;y&#39;, &#39;x&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
        v0         u0      tau  v0_0  u0_0  tau_0  success  \
0  28.2348  18.792167  2.80225   0.1   0.1   0.05     True   

                                message  n_iter       mse  
0  Optimization terminated successfully      46  0.093358  
... provided columns intersect model output.
eval_df() is dropping {&#39;y&#39;, &#39;x&#39;}
</pre></div>
</div>
</div>
</div>
<p>Note that this version of the model does <em>not</em> issue the unidentifiable model warning; reformulating the model has resolved the identifiability issue! Furthermore the solver results indicate the optimization was successful—reformulating the model has also enabled successful fitting of the model.</p>
</div>
<div class="section" id="challenge-local-minima-a-id-challenge-minima-a">
<h3><span class="section-number">17.1.4.5. </span>Challenge: Local Minima <a id="challenge-minima"></a><a class="headerlink" href="#challenge-local-minima-a-id-challenge-minima-a" title="Permalink to this headline">¶</a></h3>
<p>Since NLS can be applied to arbitrary models, we have no guarantees about the existence of a single globally-optimal parameter value. Furthermore, since <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> uses an iterative optimization procedure it can easily get “stuck” in a locally optimal model fit and fail to identify the globally optimal parameter value.</p>
<p>To illustrate the issue of local minima, let’s look at a simple example of fitting a time-varying wave.</p>
<div class="math notranslate nohighlight">
\[Y(t) = a \cos(bt) + b \sin(at).\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Define wave model</span>
<span class="n">md_wave</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">gr</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;Fast Wave&quot;</span><span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_function</span><span class="p">(</span>
        <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">var</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">],</span>
        <span class="n">out</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_bounds</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">a</span><span class="o">=</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
        <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1">## Evaluate wave model to generate data; set a=100, b=102</span>
<span class="n">df_wave_data</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">md_wave</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ev_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">df_make</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span> <span class="n">a</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">102</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try fitting this model with <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_wave_fit</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">]]</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ft_nls</span><span class="p">(</span><span class="n">md</span><span class="o">=</span><span class="n">md_wave</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;]
... eval_nls setting out = [&#39;y&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
            b     a    b_0    a_0  success  \
0  102.000451  90.0  106.0  100.0     True   

                                           message  n_iter           mse  
0  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       4  10418.950765  
</pre></div>
</div>
</div>
</div>
<p>The solver results indicate that optimization was successful, but the MSE value seems to be quite large. Let’s visually inspect the fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Visualize the fit</span>
<span class="n">df_wave_fit</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_nominal</span><span class="p">(</span><span class="n">md_wave_fit</span><span class="p">,</span> <span class="n">df_det</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">]])</span>
<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_fit</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nls_40_0.png" src="../_images/nls_40_0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778600814209)&gt;
</pre></div>
</div>
</div>
</div>
<p>This visual indicates that the fit is very poor; the peaks tend to line up but are frequently of incorrect magnitude. Periodic offsets in <span class="math notranslate nohighlight">\(b + 2\pi n\)</span> lead to identical frequencies but different wave magnitudes—this leads to multiple minima for the MSE which complicates NLS.</p>
</div>
<div class="section" id="partial-resolution-restarts">
<h3><span class="section-number">17.1.4.6. </span>Partial Resolution: Restarts<a class="headerlink" href="#partial-resolution-restarts" title="Permalink to this headline">¶</a></h3>
<p>A partial resolution is to enable the <em>multiple-restart</em> capability of <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code>; setting <code class="docutils literal notranslate"><span class="pre">n_restart</span></code> to a value greater than one uses the provided bounds / density to randomly sample initial parameter guesses <span class="math notranslate nohighlight">\(\theta_0\)</span>. The <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> routine will automatically select the minimum MSE candidate.</p>
<p>Note that whenever using a random algorithm (such as random restarts), it is a good idea to set the <code class="docutils literal notranslate"><span class="pre">seed</span></code> parameter to a fixed integer for reproducibility of computations. One can also vary the seed to get a different random draw.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_wave_fit2</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">]]</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ft_nls</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md_wave</span><span class="p">,</span>
        <span class="n">n_restart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;]
... eval_nls setting out = [&#39;y&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
Design runtime estimates unavailable; model has no timing data.
            b      a         b_0         a_0  success  \
2  102.000031  110.0  103.372173  103.705540     True   
4  102.000031  110.0  103.519512  101.084552     True   
0  102.000451   90.0  106.000000  100.000000     True   
1  102.000451   90.0  106.131189  101.413352     True   
3  108.471973   90.0  104.455730  107.872262     True   

                                           message  n_iter           mse  
2  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       3  10297.430927  
4  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       3  10297.430927  
0  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       4  10418.950765  
1  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       3  10418.950765  
3  CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       5  13184.849642  
</pre></div>
</div>
</div>
</div>
<p>Once again, we can see that optimization terminated successfully, but we have still gotten trapped in a local minimum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wave_fit2</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_nominal</span><span class="p">(</span><span class="n">md_wave_fit2</span><span class="p">,</span> <span class="n">df_det</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">]])</span>

<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_fit2</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nls_45_0.png" src="../_images/nls_45_0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778599558621)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="partial-resolution-restrict-parameter-domain">
<h3><span class="section-number">17.1.4.7. </span>Partial Resolution: Restrict parameter domain<a class="headerlink" href="#partial-resolution-restrict-parameter-domain" title="Permalink to this headline">¶</a></h3>
<p>To fully resolve this local minimum issue we will combine multiple-restarts with a constriction of the parameter space to be considered. Below we constrict the bounds for <code class="docutils literal notranslate"><span class="pre">a</span></code> and re-fit the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md_wave_restricted</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">md_wave</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">cp_bounds</span><span class="p">(</span>
        <span class="n">t</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
        <span class="n">a</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">105</span><span class="p">),</span> <span class="c1"># Restrict bounds</span>
        <span class="n">b</span><span class="o">=</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">md_wave_fit3</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">]]</span>
    <span class="o">&gt;&gt;</span> <span class="n">gr</span><span class="o">.</span><span class="n">ft_nls</span><span class="p">(</span>
        <span class="n">md</span><span class="o">=</span><span class="n">md_wave_restricted</span><span class="p">,</span>
        <span class="n">n_restart</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="mi">101</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... fit_nls setting out = [&#39;y&#39;]
... eval_nls setting out = [&#39;y&#39;]
... eval_nls setting var_fix = []
... eval_nls setting var_feat = [&#39;t&#39;]
Design runtime estimates unavailable; model has no timing data.
            b           a         b_0         a_0  success  \
4  102.000000  100.000000  103.519512  102.771138     True   
0  107.906754  100.000000  106.000000  102.500000     True   
2  110.000000  100.001182  103.372173  103.426385     True   
3  110.000000  100.001182  104.455730  104.468065     True   
1  106.395971  103.008604  106.131189  102.853338     True   

                                            message  n_iter           mse  
4  CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL       1      0.000000  
0   CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH      16   9682.805373  
2   CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       4   9923.663011  
3   CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       4   9923.663011  
1   CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH       6  10618.529860  
</pre></div>
</div>
</div>
</div>
<p>Note that the optimal parameter value is the true set used to generate the data! By using more informed bounds we have successfully guided the optmization to the global minimum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_wave_fit3</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">eval_nominal</span><span class="p">(</span><span class="n">md_wave_fit3</span><span class="p">,</span> <span class="n">df_det</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">[[</span><span class="s2">&quot;t&quot;</span><span class="p">]])</span>

<span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">mapping</span><span class="o">=</span><span class="n">aes</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_data</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_wave_fit3</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nls_49_0.png" src="../_images/nls_49_0.png" />
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ggplot: (8778600982321)&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="key-takeaways">
<h2><span class="section-number">17.1.5. </span>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>NLS is a general-purpose approach to fitting a model that is nonlinear in its parameters.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">fit_nls()</span></code> Grama routine provides a framework for fitting arbitrary Grama models.</p></li>
<li><p>Premature termination of the NLS optimization can lead to an inaccurate fit. A solution is to tighten the optimizer tolerances.</p></li>
<li><p>Model unidentifiability can prevent successful fitting. A solution is to reformulate the model to consolidate multiple parameters into a smaller set of parameters.</p></li>
<li><p>Local minima in parameter space can prevent identification of the global parameter minimum. A solution is to use a combination of multiple restarts and more informed parameter bounds.</p></li>
</ul>
</div>
<div class="section" id="grama-routines-a-id-grama-a">
<h2><span class="section-number">17.1.6. </span>Grama Routines <a id="grama"></a><a class="headerlink" href="#grama-routines-a-id-grama-a" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The <a class="reference external" href="https://github.com/zdelrosario/py_grama/blob/f8ec31640f7184560edb22b674e193d00367dfc0/grama/dfply/summary_functions.py#L231-L244">Grama routine</a> <code class="docutils literal notranslate"><span class="pre">gr.mse()</span></code> is a convenient way to compute the MSE in a data pipeline. This is useful when assessing a fitted model’s accuracy.</p></li>
<li><p>The <a class="reference external" href="https://github.com/zdelrosario/py_grama/blob/bc008517e1a0d6b88884874ac506970bf4cc1499/grama/fit_synonyms.py#L23-L73">Grama routine</a> <code class="docutils literal notranslate"><span class="pre">gr.fit_nls()</span></code> performs NLS optimization of a model in order to find fitted parameter values and return a callable model. This is the</p></li>
<li><p>The <a class="reference external" href="https://github.com/zdelrosario/py_grama/blob/bc008517e1a0d6b88884874ac506970bf4cc1499/grama/eval_opt.py#L18-L71">Grama routine</a> <code class="docutils literal notranslate"><span class="pre">gr.eval_nls()</span></code> performs NLS optimization of a model against data in order to find fitted parameter values.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./04_appendices"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="inv-propagation.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title"><span class="section-number">17. </span>Inverse Propagation</p>
            </div>
        </a>
    </div>

</div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Zachary del Rosario, Gianluca Iaccarino<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>